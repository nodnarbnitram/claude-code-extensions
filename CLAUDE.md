# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Purpose

This repository is a **working project for creating and managing Claude Code extensions**: agents, hooks, commands, and output styles. When users request new extensions, you should create them here using the patterns and templates defined below.

### Meta-Agent for Agent Creation

**IMPORTANT**: When creating or updating agents, use the `meta-agent` located at `.claude/agents/meta-agent.md`. This specialized agent:
- Fetches the latest Claude Code documentation
- Generates complete, production-ready agent files
- Follows all current best practices and conventions
- Writes directly to `.claude/agents/`

Invoke it when users ask to create or modify agents.

## Project Structure

``` md
.claude/
├── settings.json          # Hook configuration (all lifecycle events registered)
├── agents/                # Organized by category: core, orchestrators, universal, specialized
├── hooks/                 # Python scripts for lifecycle events
│   └── utils/            # Shared utilities (llm/, tts/)
└── commands/             # (Not present yet - create here for project commands)

docs/claude-code/         # Official Claude Code documentation
├── sub-agents.md
├── hooks.md
├── hooks-reference.md
├── commands-reference.md
└── output-styles.md

logs/                     # Runtime logs (generated by hooks)
```

## Creating Agents

Agents are Markdown files with YAML frontmatter stored in `.claude/agents/` (project) or `~/.claude/agents/` (user).

### Agent File Format

```markdown
---
name: agent-name
description: When this agent should be invoked (be specific and action-oriented)
tools: Read, Grep, Glob, Bash  # Optional - omit to inherit all tools
---

# Agent System Prompt

Your agent's instructions go here. Be specific about:
- The agent's role and expertise
- When it should be used (include "MUST BE USED" or "use PROACTIVELY" for auto-delegation)
- Step-by-step workflow
- Expected output format
- Delegation patterns to other agents
```

### Organization Structure

Organize agents in subdirectories by category (optional but recommended):

- **`core/`**: Quality/analysis agents
- **`orchestrators/`**: Coordination agents
- **`universal/`**: Framework-agnostic agents
- **`specialized/<tech>/`**: Framework-specific agents

### Key Principles

1. **Single responsibility**: Each agent focuses on one domain
2. **Explicit triggers**: Use "MUST BE USED" in descriptions for proactive delegation
3. **Tool restrictions**: Limit tools to what's needed (improves security and focus)
4. **Delegation patterns**: Orchestrators delegate; specialists implement
5. **Output formats**: Define structured output when reports/analysis are needed

## Creating Hooks

Hooks are shell commands executed at lifecycle events. Python hooks use `uv run --script` for dependency management.

### Hook Lifecycle Events

- **SessionStart**: When Claude Code starts/resumes
- **UserPromptSubmit**: Before Claude processes user input
- **PreToolUse**: Before any tool executes (can block)
- **PostToolUse**: After tool completes
- **PreCompact**: Before context compaction
- **SubagentStop**: When subagent completes
- **Stop**: When main agent finishes responding
- **Notification**: When Claude Code sends notifications

### Python Hook Template

```python
#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "python-dotenv",
# ]
# ///

import json
import sys
from pathlib import Path

def main():
    try:
        # Read JSON input from stdin
        input_data = json.load(sys.stdin)

        # Extract relevant fields
        # For PreToolUse/PostToolUse: tool_name, tool_input
        # For UserPromptSubmit: session_id, prompt
        # For SessionStart: session_id, source

        # Your hook logic here

        # Exit codes:
        # 0 = success, continue
        # 2 = block operation, show error to Claude
        sys.exit(0)

    except Exception:
        # Always fail gracefully
        sys.exit(0)

if __name__ == '__main__':
    main()
```

### Register Hooks

Use `/hooks` command or edit `.claude/settings.json`:

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "uv run \"$CLAUDE_PROJECT_DIR\"/.claude/hooks/pre_tool_use.py"
          }
        ]
      }
    ]
  }
}
```

### Hook Patterns from This Repository

1. **Logging pattern**: All hooks append JSON to `logs/<hook_name>.json`
2. **Safety checks**: `pre_tool_use.py` includes patterns for blocking dangerous commands
3. **Context loading**: `session_start.py` can inject git status, project context files, GitHub issues
4. **Graceful failure**: Always `sys.exit(0)` on errors to prevent blocking Claude Code

## Creating Commands

Commands are Markdown files that define reusable prompts, stored in `.claude/commands/` (project) or `~/.claude/commands/` (user).

### Command File Format

```markdown
---
description: Brief description shown in /help
argument-hint: [arg1] [arg2]  # Optional
allowed-tools: Bash(git add:*), Bash(git status:*)  # Optional
model: claude-3-5-haiku-20241022  # Optional
---

# Command Instructions

Your prompt goes here. Use:
- $ARGUMENTS for all arguments
- $1, $2, $3 for individual arguments
- @file/path for file references
- !`bash command` for executed commands (requires allowed-tools)
```

### Example Command

```markdown
---
description: Review PR and create commit
argument-hint: [pr-number]
allowed-tools: Bash(git:*)
---

Review PR #$1 and create a git commit:

1. Check current git status: !`git status`
2. Review changes: !`git diff HEAD`
3. Create commit following repo conventions
```

## Creating Output Styles

Output styles modify Claude Code's system prompt to change its behavior and personality. Stored in `.claude/output-styles/` (project) or `~/.claude/output-styles/` (user).

### Output Style Format

```markdown
---
name: Style Name
description: Brief description of what this style does
---

# Custom System Prompt

You are an interactive CLI tool that helps users with [specific purpose].

## Behaviors

[Define specific behaviors, tone, output format]
```

### Key Differences

- **Output Styles**: Modify main agent's system prompt (affect all interactions)
- **Agents**: Separate context for specific tasks
- **Commands**: Reusable prompts (stored user messages)

## Development Workflow

### Testing Hooks Locally

```bash
# Create test input
echo '{"tool_name": "Bash", "tool_input": {"command": "ls"}}' > test.json

# Test hook
uv run ./.claude/hooks/pre_tool_use.py < test.json
echo $?  # Check exit code
```

### Enabling/Disabling Safety Checks

The `pre_tool_use.py` hook has:
- `.env` file blocking: **ENABLED** (lines 93-96)
- Dangerous `rm` command blocking: **ENABLED** (lines 103-105)

Comment/uncomment these blocks to adjust safety policies.

### Best Practices

1. **Version control agents/commands**: Check `.claude/agents/` and `.claude/commands/` into git
2. **Document decisions**: Add comments in hook scripts explaining safety patterns
3. **Test incrementally**: Test each hook/agent/command individually
4. **Use matchers wisely**: Narrow hook matchers to avoid unnecessary executions
5. **Fail gracefully**: Hooks should never crash Claude Code
6. **Leverage existing patterns**: Study the hooks in this repo before creating new ones

## Key Architecture Patterns

### Safety Pattern (PreToolUse hooks)

Hooks can validate and block operations:

- Check for dangerous commands (`is_dangerous_rm_command` pattern in `pre_tool_use.py`)
- Prevent access to sensitive files (`.env` blocking enabled)
- Log all operations for audit
- Exit code 2 blocks operation and shows error to Claude

### Context Preservation Pattern (Agents)

Each agent operates in isolated context:

- Prevents context pollution in main conversation
- Enables longer overall sessions
- Allows specialized instructions per domain

## Important
- Update the `README.md` whenever adding new agents, hooks, commands, or output-styles
- See `CONTRIBUTING.md` for detailed contribution guidelines and development workflow

## References

All documentation in `docs/claude-code/` is official Claude Code reference material. Refer to these when creating extensions.
