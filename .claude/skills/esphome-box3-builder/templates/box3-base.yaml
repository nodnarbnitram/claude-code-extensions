# ESP32-S3-BOX-3 Base Configuration Template
# Hardware initialization foundation for all BOX-3 projects
# Includes: ESP-IDF framework, PSRAM, I²S audio, display, touch

substitutions:
  device_name: box3-base
  friendly_name: BOX-3 Base

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  framework:
    type: esp-idf
    version: recommended
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"
      CONFIG_AUDIO_BOARD_CUSTOM: "y"
    advanced:
      execute_from_psram: true  # Prevents UI freezing during OTA

# PSRAM Configuration (CRITICAL - 2025.2+ requirement)
psram:
  mode: octal  # BOX-3 has 16MB Octal PSRAM
  speed: 80MHz

# WiFi Configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot
  ap:
    ssid: "${friendly_name} Fallback"
    password: !secret fallback_password

captive_portal:

# Logging
logger:

# Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

# OTA Updates
ota:
  - platform: esphome
    password: !secret ota_password

# I²C Bus Configuration
i2c:
  - id: bus_a
    sda: GPIO8
    scl: GPIO18
    scan: true

# Shared I²S Audio Bus
i2s_audio:
  - id: i2s_shared
    i2s_lrclk_pin: GPIO45
    i2s_bclk_pin: GPIO17
    i2s_mclk_pin: GPIO2

# ES7210 Microphone ADC (4-channel, 16kHz)
audio_adc:
  - platform: es7210
    id: es7210_adc
    bits_per_sample: 16bit
    sample_rate: 16000
    mic_gain: 24DB  # Adjustable 0-42DB
    address: 0x40

microphone:
  - platform: i2s_audio
    id: box_mic
    adc_type: external
    i2s_din_pin: GPIO16
    channel: left
    sample_rate: 16000
    bits_per_sample: 16bit

# ES8311 Speaker DAC (mono, 48kHz, requires MCLK)
audio_dac:
  - platform: es8311
    id: es8311_dac
    bits_per_sample: 16bit
    sample_rate: 48000
    use_mclk: true  # CRITICAL - Required for ES8311
    address: 0x18

speaker:
  - platform: i2s_audio
    id: box_speaker
    dac_type: external
    i2s_dout_pin: GPIO15
    channel: left
    sample_rate: 48000
    bits_per_sample: 16bit
    buffer_duration: 100ms  # Prevents audio popping

# ILI9xxx Display (320x240, SPI, PSRAM required for 16-bit color)
spi:
  clk_pin: GPIO7
  mosi_pin: GPIO6

display:
  - platform: ili9xxx
    id: box3_display
    model: S3BOX
    data_rate: 40MHz
    cs_pin: GPIO5
    dc_pin: GPIO4
    reset_pin:
      number: GPIO48
      inverted: true
    update_interval: 100ms
    color_palette: NONE  # 16-bit color (requires PSRAM)
    dimensions:
      width: 320
      height: 240
    lambda: |-
      // Basic display - customize for your project
      it.printf(160, 10, id(roboto_16), TextAlign::TOP_CENTER, "${friendly_name}");
      it.printf(160, 120, id(roboto_12), TextAlign::CENTER, "Ready");

# GT911 Touchscreen (I²C, multi-touch)
touchscreen:
  - platform: gt911
    id: box3_touch
    i2c_id: bus_a
    address: 0x5D  # or 0x14 if address pin pulled high
    interrupt_pin:
      number: GPIO3
      ignore_strapping_warning: true
    reset_pin:
      number: GPIO48
      inverted: true  # Shared with display reset

# Fonts (customize as needed)
font:
  - file: "gfonts://Roboto"
    id: roboto_16
    size: 16

  - file: "gfonts://Roboto"
    id: roboto_12
    size: 12

# Sensors (optional - BME688 environmental sensor)
sensor:
  # WiFi Signal
  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s

  # Uptime
  - platform: uptime
    name: "${friendly_name} Uptime"
    update_interval: 60s

  # BME688 Environmental Sensor (optional)
  # - platform: bme68x_bsec2_i2c
  #   i2c_id: bus_a
  #   temperature:
  #     name: "${friendly_name} Temperature"
  #   humidity:
  #     name: "${friendly_name} Humidity"
  #   pressure:
  #     name: "${friendly_name} Pressure"
  #   gas_resistance:
  #     name: "${friendly_name} Gas Resistance"

# Text Sensors
text_sensor:
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP Address"

  - platform: version
    name: "${friendly_name} ESPHome Version"

# Binary Sensors
binary_sensor:
  - platform: status
    name: "${friendly_name} Status"
