# ESP32-S3-BOX-3 Voice Assistant Template
# Complete voice assistant with wake word, Home Assistant Assist, TTS, and audio ducking

substitutions:
  device_name: box3-voice
  friendly_name: BOX-3 Voice

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: dio
  on_boot:
    - delay: 1s
    - if:
        condition:
          switch.is_on: use_wake_word
        then:
          - voice_assistant.start_continuous:

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  framework:
    type: esp-idf
    version: recommended
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"
      CONFIG_AUDIO_BOARD_CUSTOM: "y"
    advanced:
      execute_from_psram: true

psram:
  mode: octal
  speed: 80MHz

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${friendly_name} Fallback"
    password: !secret fallback_password

captive_portal:
logger:

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

i2c:
  - id: bus_a
    sda: GPIO8
    scl: GPIO18

i2s_audio:
  - id: i2s_shared
    i2s_lrclk_pin: GPIO45
    i2s_bclk_pin: GPIO17
    i2s_mclk_pin: GPIO2

audio_adc:
  - platform: es7210
    id: es7210_adc
    bits_per_sample: 16bit
    sample_rate: 16000
    mic_gain: 24DB
    address: 0x40

microphone:
  - platform: i2s_audio
    id: box_mic
    adc_type: external
    i2s_din_pin: GPIO16
    channel: left
    sample_rate: 16000
    bits_per_sample: 16bit

audio_dac:
  - platform: es8311
    id: es8311_dac
    bits_per_sample: 16bit
    sample_rate: 48000
    use_mclk: true
    address: 0x18

speaker:
  - platform: i2s_audio
    id: box_speaker
    dac_type: external
    i2s_dout_pin: GPIO15
    channel: left
    sample_rate: 48000
    bits_per_sample: 16bit
    buffer_duration: 100ms

# Wake Word Detection (on-device)
micro_wake_word:
  models:
    - model: okay_nabu  # or hey_jarvis, alexa, hey_mycroft
  on_wake_word_detected:
    - voice_assistant.start:

# Voice Assistant Pipeline
voice_assistant:
  id: va
  microphone: box_mic
  speaker: box_speaker
  noise_suppression_level: 1
  auto_gain: 31dBFS
  volume_multiplier: 2.0
  vad_threshold: 3

  on_listening:
    - light.turn_on:
        id: status_light
        blue: 100%
        red: 0%
        green: 0%
        effect: "Pulse"
    - lambda: id(voice_state) = "Listening...";

  on_stt_vad_end:
    - light.turn_on:
        id: status_light
        blue: 100%
        red: 0%
        green: 0%
        effect: "Fast Pulse"
    - lambda: id(voice_state) = "Thinking...";

  on_tts_start:
    - light.turn_on:
        id: status_light
        blue: 0%
        red: 0%
        green: 100%
    - lambda: id(voice_state) = "Speaking...";

  on_end:
    - delay: 100ms
    - wait_until:
        not:
          speaker.is_playing: box_speaker
    - light.turn_off: status_light
    - lambda: id(voice_state) = "Idle";
    - if:
        condition:
          switch.is_on: use_wake_word
        then:
          - voice_assistant.start_continuous:

  on_error:
    - light.turn_on:
        id: status_light
        red: 100%
        blue: 0%
        green: 0%
    - delay: 1s
    - light.turn_off: status_light
    - lambda: id(voice_state) = "Error";
    - if:
        condition:
          switch.is_on: use_wake_word
        then:
          - voice_assistant.start_continuous:

  on_client_connected:
    - if:
        condition:
          switch.is_on: use_wake_word
        then:
          - voice_assistant.start_continuous:

  on_client_disconnected:
    - voice_assistant.stop:

# Globals
globals:
  - id: voice_state
    type: std::string
    initial_value: '"Idle"'

# Switches
switch:
  - platform: template
    name: "Use Wake Word"
    id: use_wake_word
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    entity_category: config
    on_turn_on:
      - lambda: id(va).set_use_wake_word(true);
      - if:
          condition:
            not:
              - voice_assistant.is_running
          then:
            - voice_assistant.start_continuous
    on_turn_off:
      - voice_assistant.stop
      - lambda: id(va).set_use_wake_word(false);

# Display
spi:
  clk_pin: GPIO7
  mosi_pin: GPIO6

display:
  - platform: ili9xxx
    id: box3_display
    model: S3BOX
    data_rate: 40MHz
    cs_pin: GPIO5
    dc_pin: GPIO4
    reset_pin:
      number: GPIO48
      inverted: true
    update_interval: 100ms
    color_palette: NONE
    dimensions:
      width: 320
      height: 240
    lambda: |-
      // Title
      it.printf(160, 10, id(roboto_16), TextAlign::TOP_CENTER, "${friendly_name}");

      // Voice state
      it.printf(160, 100, id(roboto_14), TextAlign::CENTER, "%s", id(voice_state).c_str());

      // WiFi signal
      if (id(wifi_signal_sensor).has_state()) {
        it.printf(10, 220, id(roboto_10), "WiFi: %.0f dBm", id(wifi_signal_sensor).state);
      }

# Touchscreen
touchscreen:
  - platform: gt911
    i2c_id: bus_a
    address: 0x5D
    interrupt_pin:
      number: GPIO3
      ignore_strapping_warning: true
    reset_pin:
      number: GPIO48
      inverted: true

# Fonts
font:
  - file: "gfonts://Roboto"
    id: roboto_16
    size: 16

  - file: "gfonts://Roboto"
    id: roboto_14
    size: 14

  - file: "gfonts://Roboto"
    id: roboto_10
    size: 10

# Status Light (RGB LED on GPIO38, 39, 40)
light:
  - platform: esp32_rmt_led_strip
    id: status_light
    name: "Status LED"
    pin: GPIO39
    num_leds: 1
    rmt_channel: 0
    rgb_order: GRB
    chipset: WS2812
    effects:
      - pulse:
          name: "Pulse"
      - pulse:
          name: "Fast Pulse"
          transition_length: 0.5s
          update_interval: 0.5s

# Sensors
sensor:
  - platform: wifi_signal
    id: wifi_signal_sensor
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s

  - platform: uptime
    name: "${friendly_name} Uptime"
    update_interval: 60s

# Text Sensors
text_sensor:
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP Address"

  - platform: version
    name: "${friendly_name} ESPHome Version"

  - platform: template
    name: "${friendly_name} Voice State"
    lambda: return id(voice_state);
    update_interval: 1s

# Binary Sensors
binary_sensor:
  - platform: status
    name: "${friendly_name} Status"
